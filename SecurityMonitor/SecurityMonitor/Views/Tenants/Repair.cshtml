@model SecurityMonitor.Models.RepairVM

@{
    ViewBag.Title = "Repair";
    Layout = "~/Views/Shared/_LayoutTenant .cshtml";
}


<!--Request Form-->
<div class="modal fade" id="myModal" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header nopadding " id="modalheaderid">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close" ><span aria-hidden="true">&times;</span></button>
                <div class="col-lg-12 colmd-12  repairrequestformheader text-center ">
                    <h4 class="modal-title" id="myModalLabel ">New Request</h4>
                </div> 
            </div>
            <div class="modal-body lightgrey">
                <div class="col-lg-12 col-md-12 ">
                    <div class="col-lg-12 col-md-12  squarearoundform">
                        <div class="col-lg-6 col-md-6 nopadding displayinline rformrowheight padding20px ">
                            <span class="displayinline">Request</span>
                            @Html.DropDownList("Categories", @Model.RequestCategories, "Select Category", new { @class = "displayinline form-control", data_bind = "value:Category" })
                            @*<span data-bind="text:Category">oio</span>*@
                        </div>

                        <div class="col-lg-6 col-md-6 nopadding rformrowheight padding20px">
                            <span class="displayinline">
                                Ugency:
                                <span class="padding-left20px">
                                    <span class="backgroubdlightgrey;">
                                        High @Html.RadioButton("rbtnHighlow", "1", false, new { @class = "displayinline ", data_bind = "checked:Urgency" })
                                    </span>
                                    <span class="backgroubdlightgrey;">
                                        Low @Html.RadioButton("rbtnHighlow", "2", false, new { @class = "displayinline ", data_bind = "checked:Urgency" })
                                    </span>
                                </span>
                            </span>
                            @*<span data-bind="text:Urgency">oio</span>*@
                        </div>
                        <div class="col-lg-12 col-md-12 nopadding rformrowheight1 ">
                            <div class="col-lg-6 col-md-6 nopadding rformrowheight1 padding30px">
                                 Contact(s) Information<br />

                            </div>
                            <div class="col-lg-6 col-md-6 nopadding rformrowheight1 padding30px">
                                <button class="btn btn-default btn-sm" id="primaryid">Primary contact</button>
                                <button class="btn btn-default btn-sm" id="contactotherid">Add a secondary contact</button>
                            </div>
                        </div>                   

                      
                        <div class="col-lg-12 col-md-12 nopadding border-bottomcust" id="primaryinfomation">
                            <div class="col-lg-2 col-md-2 othercontactinforowh text-left">
                                Primary:
                            </div>
                            <div class="col-lg-3 col-md-3 othercontactinforowh text-left">
                                Name: @Model.tenant.FirstName @Model.tenant.LastName
                            </div>
                            <div class="col-lg-3 col-md-3 othercontactinforowh  text-left">
                                Phone: @Model.tenant.Phone
                            </div>
                            <div class="col-lg-4 col-md-4 othercontactinforowh  text-left">
                                Email: @Model.tenant.Username
                            </div>
                        </div>
                        <div class="col-lg-12 col-md-12 nopadding rformrowheight  blueDefault othercontactinfo ">
                            
                                <div class="col-lg-4 col-md-4 othercontactinforowh text-center">
                                    <span class="displayinline "> Full Name:</span> @Html.TextBox("OtherContactName", null, new { @Placeholder = "Enter Full Name", @class = "form-control displayinline input-sm ", Data_bind = "value:OtherContactName,valueUpdate:'afterkeydown'" })
                                </div>
                                <div class="col-lg-4 col-md-4 othercontactinforowh text-center">
                                    <span class="displayinline">Phone</span>: @Html.TextBox("OtherContactPhone", null, new { @Placeholder = "345.898.0099", @class = "form-control displayinline input-sm", Data_bind = "value:OtherContactPhone,valueUpdate:'afterkeydown'" })

                                </div>
                                <div class="col-lg-4 col-md-4 othercontactinforowh text-center">
                                    <span class="displayinline">Email</span>: @Html.TextBox("OtherContactEmail", null, new { @Placeholder = "Example@mail.com (Optional)", @class = "form-control displayinline input-sm", Data_bind = "value:OtherContactEmail,valueUpdate:'afterkeydown'" })

                                </div>

                            </div>
                        


                        <div class="col-lg-6 col-md-6 nopadding rformrowheight padding20px">
                            <span class="">
                                Permission to Enter:
                                <span class="padding-left20px">
                                    Yes @Html.RadioButton("permissionr", "Yes", false, new { data_bind = "checked:permission" })
                                    Schedule @Html.RadioButton("permissionr", "No", false, new { data_bind = "checked:permission" })
                                </span>
                            </span>
                           
                        </div>
                        <div class="col-lg-6 col-md-6 nopadding rformrowheight  padding20px">
                            <span class="btn btn-default btn-file btn-sm">Attach Photo: <input type="file" name="file" /></span><span data-bind="text:fileName"></span>

                        </div>

                        <div class="col-lg-12 col-md-12 nopadding padding20px">
                            <span>Enter Instructions: @Html.TextArea("instructions", new { @class = " rrform form-control", @cols = 300, @rows = 2, data_bind = "value:Instruction, valueUpdate:'afterkeydown'" })</span>
                           
                        </div>
                        <div class="col-lg-12 col-md-12 nopadding padding20px">
                            <span>Problem Description: @Html.TextArea("Description", new { @class = " rrform form-control", rows = 8, data_bind = "value:Description, valueUpdate:'afterkeydown'" })</span>
                           
                        </div>
                        </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default "  data-dismiss="modal">Cancel</button>

                <button class="btn btn-info " type="button" data-dismiss="modal" data-bind="click:SendRequest">Send Request</button>
            </div>
        </div>
    </div>
</div>

<!--Request Form-->


<div class="row">
    <div class="col-lg-12 col-md-12 text-center  repairheading">
       <h1> Repair Page</h1>
    </div>
</div>

<div class="row repairheight">
    <div class="col-lg-12 col-md-12  instructionrepairbox">
        <div class="col-lg-12 col-md-12  instructionrepair ">
            <p>The words requests and holds and reserves are interchangeable.
             When you place a request, your name is put on a list of people 
            waiting for an item in the Library’s collection. When the item 
            becomes available for you, we notify you by telephone or email
             to pick up the item, notify you and place the item on a bookmobile
             for you, or mail the item to you.
                The words requests and holds and reserves are interchangeable.
                When you place a request, your name is put on a list of people
                waiting for an item in the Library’s collection. When the item
                becomes available for you, we notify you by telephone or email
                to pick up the item, notify you and place the item on a bookmobile
                for you, or mail the item to you.</p>
        </div>
    </div>

    <div class="col-lg-12 col-md-12  requestlogbox nopadding">
        <div class="col-lg-12 col-md-12 text-center  headingopenerequests ">
            <h1 id="openrequesttitle" class="displayinline  ">Open Request</h1>
            <button class="btn btn-link pull-right displayinline OpenRequestsSettings fa fa-search fa-3x"></button>            
            <button class="btn btn-link pull-right displayinline OpenRequestsSettings fa fa-cog fa-3x"></button>
            <button class="btn btn-link pull-right displayinline openrequestssettings fa fa-plus-circle fa-3x" id="hitme" data-toggle="modal" data-target="#myModal"></button>
        </div>
        <div class="col-lg-12 col-md-12  nopadding Openrequestheader blueDefault">
            <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 ">Date</span>
            <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 ">Request#</span>
            <span class="col-lg-4 text-center OpenRequestCollunm col-md-4 ">Repair Request</span>
            <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 ">Status</span>
            <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 ">Edit</span>
        </div>
        <div class="nopadding col-lg-12 col-md-12" id="mywidth">
            <div class="progress">
                <div class="progress-bar progress-bar-striped active bar" role="progressbar"
                     aria-valuenow="900" aria-valuemin="0" aria-valuemax="100" data-bind="style:{width:counter()+'%' }">
                    <span data-bind="text:counter"></span>% Loading Requests..
                </div>
            </div>
            </div>
            <div class="nopadding col-lg-12 col-md-12" data-bind="foreach:request ">
                <div class="col-lg-12 col-md-12  nopadding OpenRequestRows">
                    <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 " data-bind="text:rDate"></span>
                    <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 " data-bind="text:RequestNumber"></span>
                    <span class="col-lg-4 text-center OpenRequestCollunm col-md-4 " data-bind="text:Description"></span>
                    <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 " data-bind="text:Status"></span>
                    <span class="col-lg-2 text-center OpenRequestCollunm col-md-2 ">o</span>
                </div>
            </div>



        </div>
    </div>

@section scripts{
<script src="~/Scripts/jquery-2.1.3.min.js"></script>
<script src="~/Scripts/jquery-ui-1.11.4.min.js"></script>
        <script src="~/Scripts/knockout-3.1.0.js"></script>
<script src="~/Scripts/knockout.mapping-latest.js"></script>
<script src="~/Scripts/jquery.signalR2.1.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>


    <script type="text/javascript">
            
        $(document).on('change', '.btn-file :file', function () {
            var input = $(this),
                numFiles = input.get(0).files ? input.get(0).files.length : 1,
                label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            input.trigger('fileselect', [numFiles, label]);
        });


        

        $(function () {

            $('#contactotherid').on('click', function () {
                $('.othercontactinfo').slideToggle();
                $('#contactotherid').toggleClass("btn-default");
                $('#contactotherid').toggleClass("btn-primary");
                
            });
        });

        $(function () {

            $('#primaryid').on('click', function () {
                $('#primaryinfomation').slideToggle();
                $('#primaryid').toggleClass("btn-default");
                $('#primaryid').toggleClass("btn-primary");

            });
        });




        


     

        $(function () {

            
           

            var viewModel = function () {

              





                var self = this;
                self.Phone = ko.observable();
                self.Email = ko.observable();
                self.Urgency = ko.observable();
                self.Category = ko.observable();
                self.Instruction = ko.observable();
                self.Description = ko.observable();
                self.permission = ko.observable();

                self.OtherContactPhone = ko.observable();
                self.OtherContactName = ko.observable();
                self.OtherContactEmail = ko.observable();

                self.request = ko.observableArray();




                

                self.fileName = ko.observable();

                $(document).ready(function () {
                    $('.btn-file :file').on('fileselect', function (event, numFiles, label) {
                        self.fileName(" "+ label)                        
                    });
                });
                var $myvalue = 0;
                var request = {
                    RepairRequestCategoriesID: self.Category,
                    ProblemDescription: self.Description,
                    UrgencyID: self.Urgency,
                    ContactPhone: "@Model.tenant.Phone",                   
                    Permissiontoenter: self.permission,
                    Email: "@Model.tenant.Username",
                    Instructions_: self.Instruction,
                    PhotoUrl: "",
                    TenantID: "@Model.TenantID",
                    Status: "On process",
                    RequestedDate: new Date(),
                    OtherContactPhone: self.OtherContactPhone,
                    OtherContactName:self.OtherContactName,
                    OtherContactEmail:self.OtherContactEmail
                };




                self.SendRequest = function (fields)
                {
                   // alert(request);
                    debugger;
                    $.ajaxSettings.traditional = true;
                    self.request.removeAll();
                    $.ajax({
                        type: "POST",
                        url: '/Tenants/AddRequest/',
                        data: ko.toJSON(request),
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                           
                        }
                    }).complete(function () {
                        //reset all observable to empty
                       
                        setTimeout(function () {
                        }, 6000);
                        self.counter(0);
                    $('#mywidth').show();
                    var counter = 0;
                    var interval = setInterval(function () {
                        counter++;
                        self.counter(counter) + 1;

                        // Display 'counter' wherever you want to display it.
                        if (counter == 96) {
                            // Display a login box
                            clearInterval(interval);
                            
                        }
                    }, 62.5);
                    
                        self.Phone("");
                        self.Email("");
                        self.Urgency("");
                        self.Category("");
                        self.Instruction("");
                        self.Description("");
                        self.permission("");
                        self.OtherContactPhone("");
                        self.OtherContactName("");
                        self.OtherContactEmail("");
                    });

                };


                self.counter = ko.observable(0);
                
                              $(function () {
                  

                    var counter = 0;
                    var interval = setInterval(function () {
                        counter++;
                        self.counter(counter)+1;

                        // Display 'counter' wherever you want to display it.
                        if (counter == 96) {
                            // Display a login box
                            clearInterval(interval);
                        }
                    },62.5);
                });

                $(function () {

                    setTimeout(function () {
                        debugger;
                       
                        $.ajaxSettings.traditional = true;
                        $.ajax({
                            type: "GET",
                            url: '/Tenants/loadRequest/',
                            data: { TenantID: "@Model.TenantID" },
                            contentType: "application/json; charset=utf-8",
                            dataType: "json"
                        });
                    }, 6000);

                });


                // Reference the auto-generated proxy for the hub.
                //Notification
                var Notification = $.connection.notificationsHub;
                Notification.client.newRepairRequestList = function (JsonRepairRequests) {
                  debugger
                  if ($myvalue == 0) {
                      $('#mywidth').hide();
                      $myvalue = 1;
                        var jsonresult = JSON.stringify(JsonRepairRequests.Data);// Json.stringify make an object into a json string
                        // debugger;
                        var TrkPkgs = JSON.parse(jsonresult); //JSON.parse makes a json string into a json object example obj.FirstName
                        for (var i = 0; i < TrkPkgs.length; i++) {
                            debugger;
                            self.request.push({
                                rDate: TrkPkgs[i].RequestedDate,
                                RequestNumber: "120320151",
                                Description: TrkPkgs[i].ProblemDescription,
                                Status: TrkPkgs[i].Status
                            });

                        }
                    }
                    else {
                        setTimeout(function () {
                            $('#mywidth').hide();
                      
                        var jsonresult = JSON.stringify(JsonRepairRequests.Data);// Json.stringify make an object into a json string
                        // debugger;
                        var TrkPkgs = JSON.parse(jsonresult); //JSON.parse makes a json string into a json object example obj.FirstName
                        for (var i = 0; i < TrkPkgs.length; i++) {

                            self.request.push({
                                rDate: TrkPkgs[i].RequestedDate,
                                RequestNumber: "120320151",
                                Description: TrkPkgs[i].ProblemDescription,
                                Status: TrkPkgs[i].Status
                            });

                        }
                        }, 6000);
                    }

                   
                };


                // Start the connection.outgoing here
                $.connection.hub.start().done(function () { console.log("connected, Connection ID: " + $.connection.hub.id) });
                //reconnect after disconect
                $.connection.hub.disconnected(function () {
                    setTimeout(function () {
                        $.connection.hub.start();
                    }, 5000); // Restart connection after 5 seconds.
                });
                
            };

            ko.applyBindings(viewModel);
            
           






        });
        

        


    </script>

}